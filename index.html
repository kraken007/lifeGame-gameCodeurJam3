<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8"/>
    <title>Life Game - Gamecodeur GameJam #3</title>
    <script type="text/javascript" src="./js/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
            text-align: center;
            background-color: linen;
        }

        #game {
            width: 800px;
            height: 600px;
            margin-left: auto;
            margin-right: auto;
            margin-top: 50px;
        }
    </style>
</head>

<body>
<div id='game'></div>
<script type="text/javascript">
    //crée la fenetre de jeu
    var game = new Phaser.Game(800, 600, Phaser.CANVAS, 'game');

    //state menu
    var menu = {

        preload: function () {
            game.load.image('cellule', './img/cellule.jpg');
            game.load.image('back', './img/back.png');
            game.load.image('editor', './img/editor.png');
            game.load.image('next', './img/next.png');
            game.load.image('playrand', './img/playrand.png');
            game.load.image('previous', './img/previous.png');
            game.load.image('rules', './img/rules.png');
            game.load.image('start', './img/start.png');
            game.load.image('reset', './img/reset.png');
        },
        create: function () {
            var centreY = game.world.height / 2;
            var centreX = game.world.width / 2;
            var espace = 30;

            var playRandButton = game.add.button(centreX - (game.cache.getImage('playrand').width / 2), centreY - (game.cache.getImage('playrand').height / 2) - game.cache.getImage('editor').height - espace, 'playrand', this.playRand, this);
            var editorButton = game.add.button(centreX - (game.cache.getImage('editor').width / 2), centreY - (game.cache.getImage('editor').height / 2), 'editor', this.editor, this);
            var rulesButton = game.add.button(centreX - (game.cache.getImage('rules').width / 2), centreY - (game.cache.getImage('rules').height / 2) + game.cache.getImage('editor').height + espace, 'rules', this.rules, this);
        },
        update: function () {

        }
        , playRand: function () {
            var param = [
                [0, 0, 0, 0, 1, 1, 0, 0, 0, 0]
                , [0, 0, 0, 1, 0, 0, 1, 0, 0, 0]
                , [0, 0, 0, 1, 0, 1, 0, 0, 0, 0]
                , [0, 1, 1, 0, 1, 0, 0, 0, 1, 0]
                , [1, 0, 0, 1, 0, 0, 0, 1, 0, 1]
                , [1, 0, 1, 0, 0, 0, 1, 0, 0, 1]
                , [0, 1, 0, 0, 0, 1, 0, 1, 1, 0]
                , [0, 0, 0, 0, 1, 0, 1, 0, 0, 0]
                , [0, 0, 0, 1, 0, 0, 1, 0, 0, 0]
                , [0, 0, 0, 0, 1, 1, 0, 0, 0, 0]
            ];
            game.state.start('editor', true, false, param);
        }
        , editor: function () {
            game.state.start('editor', true, false, null);
        }
        , rules: function () {
            game.state.start('intro');
        }
    };

    //state intro
    var intro = {
        preload: function () {
            game.load.image('cellule', './img/cellule.jpg');
            game.load.image('back', './img/back.png');
            game.load.image('editor', './img/editor.png');
            game.load.image('next', './img/next.png');
            game.load.image('playrand', './img/playrand.png');
            game.load.image('previous', './img/previous.png');
            game.load.image('rules', './img/rules.png');
            game.load.image('start', './img/start.png');
            game.load.image('reset', './img/reset.png');
            this.tabText = [
                "Le jeu de la vie c'est quoi ? \n C'est un automate cellulaire imaginé \n par John Horton Conway en 1970.",
                "Le jeu se déroule sur une grille à deux dimensions,\n dont les cases qu’on appelle des « cellules », \n peuvent prendre deux états distincts : \n « vivantes » ou « mortes » ",
                "À chaque étape,\n l’évolution d’une cellule est entièrement \n déterminée par l’état de ses huit \n voisines de la façon suivante :",
                "1) Une cellule morte possédant exactement trois\n voisines vivantes devient vivante \n 2) Si une cellule a strictement moins de deux \n ou strictement plus de trois voisines vivantes,\n elle est morte."
            ];
            this.text = '';
            this.conteurText = 0;
            this.buttonNext = null;
            this.buttonPrevious = null;
            this.buttonStart = null;
        }
        , create: function () {
            this.text = game.add.text(game.world.centerX, game.world.centerY, this.tabText[this.conteurText], {
                font: "32px Arial"
                , fill: "#ff0044"
                , align: "center"
            });
            var espace = game.world.width / 3;
            var tailleCellule = game.cache.getImage('cellule').width;
            var positionX = (espace - tailleCellule) / 2;
            var positionY = game.world.height - 100;

            this.text.anchor.setTo(0.5, 0.5);

            this.buttonNext = game.add.button(positionX + espace, positionY, 'next', this.nextText, this);
            this.buttonNext.visible = true;

            this.buttonPrevious = game.add.button(positionX, positionY, 'previous', this.previousText, this);
            this.buttonPrevious.visible = false;

            this.buttonStart = game.add.button(positionX + (espace * 2), positionY, 'start', this.startGame, this);
        }
        , update: function () {
            if (this.conteurText > 0 && this.buttonPrevious.visible === false) {
                this.buttonPrevious.visible = true;
            }
            if (this.conteurText == 0 && this.buttonPrevious.visible === true) {
                this.buttonPrevious.visible = false;
            }
            if (this.conteurText == (this.tabText.length - 1) && this.buttonNext.visible === true) {
                this.buttonNext.visible = false;
            }
            if (this.conteurText < (this.tabText.length - 1) && this.buttonNext.visible === false) {
                this.buttonNext.visible = true;
            }
        }
        , nextText: function () {
            this.conteurText += 1;
            this.text.setText(this.tabText[this.conteurText]);
        }
        , previousText: function () {
            this.conteurText -= 1;
            this.text.setText(this.tabText[this.conteurText]);
        }, startGame: function () {
            this.state.start('editor', true, false, null);
        }
    };

    //state editor
    var editor = {
        init: function (param) {

            if (typeof param === 'object' && param !== null) {
                this.DEPART = param;
            } else {
                this.DEPART = [];
            }
        }
        , preload: function () {
            game.load.image('cellule', './img/cellule.jpg');
            game.load.image('start', './img/start.png');
            //grille
            this.tailleCellule = game.cache.getImage('cellule').width;
            this.nbColonne = (this.DEPART.length > 0) ? this.DEPART[0].length : 3;
            this.nbLigne = (this.DEPART.length > 0) ? this.DEPART.length : 3;
            this.tailleGrille = this.nbColonne * this.nbLigne;
            this.tabLine = [];
            this.grille = new Array(this.nbLigne);
            this.latenceClick = 300;
            this.nextClick = 0;
            this.startX = (game.world.width - (this.nbColonne * this.tailleCellule)) / 2;
            this.startY = (game.world.height - (this.nbLigne * this.tailleCellule)) / 2;
            //cycle jeu
            this.start = false;
            this.cycle = true;
            this.fps = 3;
        },
        create: function () {

            this.initGrille();

            if(this.DEPART.length === 0){
                for (var d = 0; d < this.nbLigne; d++) {
                    this.DEPART[d] = new Array(this.nbColonne);
                }
            }

            for (var l = 0; l < this.nbLigne; l++) {
                for (var c = 0; c < this.nbColonne; c++) {
                    var tmpCellule = this.grille[l][c];
                    tmpCellule.isAlive = (this.DEPART[l][c] === 1);
                    tmpCellule.visible = (this.DEPART[l][c] === 1);
                }
            }


            //ajout du bouton start
            this.buttonStart = game.add.button(game.world.width / 2, game.world.height - 100, 'start', this.nextState, this);
        },
        update: function () {

            //gestion de l'editeur
            var caseX = Math.floor((game.input.activePointer.x - this.startX) / 32);
            var caseY = Math.floor((game.input.activePointer.y - this.startY) / 32);

            if (game.input.activePointer.leftButton.isDown
                && caseY < this.nbLigne
                && caseY >= 0
                && caseX >= 0
                && caseX < this.nbColonne
                && game.time.now > this.nextClick) {

                this.nextClick = game.time.now + this.latenceClick;
                var cel = this.grille[caseX][caseY];
                if (cel.isAlive === true) {
                    cel.isAlive = false;
                    cel.visible = false;
                    this.DEPART[caseX][caseY] = 0;
                } else {
                    cel.isAlive = true;
                    cel.visible = true;
                    this.DEPART[caseX][caseY] = 1;
                }
            }
            //gestion du jeu
            if (this.start === true && this.buttonStart.visible === true) {
                game.time.desiredFps = this.fps;
                this.buttonStart.visible = false;
            }
            if (this.start === true && this.cycle === true) {
                this.cycle = false;
                var celluleModifier = [];
                var nbCelluleDead = 0;
                for (var y = 0; y < this.nbLigne; y++) {
                    for (var x = 0; x < this.nbColonne; x++) {
                        var cellule = this.grille[x][y];
                        var compteur = 0;
                        this.isAlive(x - 1, y - 1) ? compteur++ : null;
                        this.isAlive(x, y - 1) ? compteur++ : null;
                        this.isAlive(x + 1, y - 1) ? compteur++ : null;
                        this.isAlive(x - 1, y) ? compteur++ : null;
                        this.isAlive(x + 1, y) ? compteur++ : null;
                        this.isAlive(x - 1, y + 1) ? compteur++ : null;
                        this.isAlive(x, y + 1) ? compteur++ : null;
                        this.isAlive(x + 1, y + 1) ? compteur++ : null;
                        if (compteur === 3) {
                            cellule.nextTurn = 'life';
                            celluleModifier.push(cellule);
                        }
                        else if (compteur < 2 || compteur > 3) {
                            cellule.nextTurn = 'dead';
                            celluleModifier.push(cellule);
                            nbCelluleDead++;
                        }
                        else {
                            cellule.nextTurn = null;
                        }
                    }
                }
                for (var m = 0; m < celluleModifier.length; m++) {
                    var tmp = celluleModifier[m];
                    if (tmp.nextTurn === 'life') {
                        tmp.isAlive = true;
                        tmp.visible = true;
                        tmp.nextTurn = null;
                    }
                    else if (tmp.nextTurn === 'dead') {
                        tmp.isAlive = false;
                        tmp.visible = false;
                        tmp.nextTurn = null;
                    }
                    else {
                        tmp.nextTurn = null;
                    }
                }
                if (nbCelluleDead === this.tailleGrille) {
                    alert('Toutes les cellules sont mortes :(');
                    game.time.desiredFps = 30;
                    game.state.restart(false,true,this.DEPART);
                }
                this.cycle = true;
            }

        }
        , render: function () {
            for (var i = 0; i < this.tabLine.length; i++) {
                game.debug.geom(this.tabLine[i], 'LightSeaGreen');
            }
        }
        , initGrille: function () {
            //traçage des lignes
            for (var i = 0; i <= this.nbColonne; i++) {
                this.tabLine.push(new Phaser.Line((this.startX + ( this.tailleCellule * i)), this.startY, (this.startX + ( this.tailleCellule * i)), (this.startY + ( this.tailleCellule * this.nbLigne))));
            }
            for (var j = 0; j <= this.nbLigne; j++) {
                this.tabLine.push(new Phaser.Line(this.startX, (this.startY + ( this.tailleCellule * j)), (this.startX + ( this.tailleCellule * this.nbColonne)), (this.startY + ( this.tailleCellule * j))));
                this.grille[j] = new Array(this.nbColonne);
            }
            //ajout des sprites dans les cases
            for (var l = 0; l < this.nbLigne; l++) {
                for (var c = 0; c < this.nbColonne; c++) {
                    var cellule = game.add.sprite(this.startX + ( this.tailleCellule * l), this.startY + ( this.tailleCellule * c), 'cellule');
                    cellule.setScaleMinMax(0.90, 0.90);
                    cellule.anchor.x = -0.07;
                    cellule.anchor.y = -0.07;
                    cellule.isAlive = false;
                    cellule.visible = false;
                    cellule.nextTurn = null;
                    this.grille[l][c] = cellule;
                }
            }
        }
        , nextState: function () {
            this.start = true;
        }
        , isAlive: function (px, py) {
            try {
                var enVie = this.grille[px][py].isAlive;
            }
            catch (e) {
                return false;
            }
            return enVie;
        }
    };

    //ajout des games states
    game.state.add('menu', menu);
    game.state.add('intro', intro);
    game.state.add('editor', editor);
    //choix de la première scene
    game.state.start('menu');
</script>
</body>

</html>