<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8"/>
    <title>Life Game - Gamecodeur GameJam #3</title>
    <script type="text/javascript" src="./js/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
            text-align: center;
            background-color: linen;
        }

        #game {
            width: 800px;
            height: 600px;
            margin-left: auto;
            margin-right: auto;
            margin-top: 50px;
        }
    </style>
</head>

<body>
<div id='game'></div>
<script type="text/javascript">
    //crée la fenetre de jeu
    var game = new Phaser.Game(800, 600, Phaser.CANVAS, 'game');

    //state intro
    var intro = {
        preload: function () {
            game.load.image('cellule', './img/cellule.jpg');
            this.tabText = [
                "Le jeu de la vie c'est quoi ? \n C'est un automate cellulaire imaginé \n par John Horton Conway en 1970.",
                "Le jeu se déroule sur une grille à deux dimensions,\n dont les cases qu’on appelle des « cellules », \n peuvent prendre deux états distincts : \n « vivantes » ou « mortes » ",
                "À chaque étape,\n l’évolution d’une cellule est entièrement \n déterminée par l’état de ses huit \n voisines de la façon suivante :",
                "1) Une cellule morte possédant exactement trois\n voisines vivantes devient vivante \n 2) Si une cellule a strictement moins de deux \n ou strictement plus de trois voisines vivantes,\n elle est morte."
            ];
            this.text = '';
            this.conteurText = 0;
            this.buttonNext = null;
            this.buttonPrevious = null;
            this.buttonStart = null;
        }
        , create: function () {
            this.text = game.add.text(game.world.centerX, game.world.centerY, this.tabText[this.conteurText], {
                font: "32px Arial"
                , fill: "#ff0044"
                , align: "center"
            });
            var espace = game.world.width / 3;
            var tailleCellule = game.cache.getImage('cellule').width;
            var positionX = (espace - tailleCellule) / 2;
            var positionY = game.world.height - 100;

            this.text.anchor.setTo(0.5, 0.5);

            this.buttonNext = game.add.button(positionX + espace, positionY, 'cellule', this.nextText, this);
            this.buttonNext.scale.setTo(2, 1);
            var textButtonNext = game.add.text(0, 5, "Next", {font: "16px Arial", fill: "#2E8B57", align: "center"});
            this.buttonNext.addChild(textButtonNext);
            this.buttonNext.visible = true;

            this.buttonPrevious = game.add.button(positionX, positionY, 'cellule', this.previousText, this);
            this.buttonPrevious.scale.setTo(2, 1);
            var textButtonPrevious = game.add.text(0, 5, "Previous", {
                font: "16px Arial",
                fill: "#ff0044",
                align: "center"
            });
            this.buttonPrevious.addChild(textButtonPrevious);
            this.buttonPrevious.visible = false;

            this.buttonStart = game.add.button(positionX + (espace * 2), positionY, 'cellule', this.startGame, this);
            this.buttonStart.scale.setTo(2, 1);
            var textButtonStart = game.add.text(0, 5, "Editor", {font: "16px Arial", fill: "#000000", align: "center"});
            this.buttonStart.addChild(textButtonStart);
        }
        , update: function () {
            if (this.conteurText > 0 && this.buttonPrevious.visible === false) {
                this.buttonPrevious.visible = true;
            }
            if (this.conteurText == 0 && this.buttonPrevious.visible === true) {
                this.buttonPrevious.visible = false;
            }
            if (this.conteurText == (this.tabText.length - 1) && this.buttonNext.visible === true) {
                this.buttonNext.visible = false;
            }
            if (this.conteurText < (this.tabText.length - 1) && this.buttonNext.visible === false) {
                this.buttonNext.visible = true;
            }
        }
        , nextText: function () {
            this.conteurText += 1;
            this.text.setText(this.tabText[this.conteurText]);
        }
        , previousText: function () {
            this.conteurText -= 1;
            this.text.setText(this.tabText[this.conteurText]);
        }, startGame: function () {
            this.state.start('editor');
        }
    };

    //state editor
    var editor = {
        preload: function () {
            game.load.image('cellule', './img/cellule.jpg');
            //grille
            this.nbColonne = 10;
            this.nbLigne = 10;
            this.tailleGrille = this.nbColonne * this.nbLigne;
            this.tabLine = [];
            this.grille = new Array(this.nbLigne);
            this.latenceClick = 300;
            this.nextClick = 0;
            //cycle jeu
            this.start = false;
            this.cycle = true;
            this.fps = 3;
        },
        create: function () {
            var tailleCellule = game.cache.getImage('cellule').width;
            this.startX = (game.world.width - (this.nbColonne * tailleCellule)) / 2;
            this.startY = (game.world.height - (this.nbLigne * tailleCellule)) / 2;

            //traçage des lignes
            for (var i = 0; i <= this.nbColonne; i++) {
                this.tabLine.push(new Phaser.Line((this.startX + (tailleCellule * i)), this.startY, (this.startX + (tailleCellule * i)), (this.startY + (tailleCellule * this.nbLigne))));
            }
            for (var j = 0; j <= this.nbLigne; j++) {
                this.tabLine.push(new Phaser.Line(this.startX, (this.startY + (tailleCellule * j)), (this.startX + (tailleCellule * this.nbColonne)), (this.startY + (tailleCellule * j))));
                this.grille[j] = new Array(this.nbColonne);
            }
            //ajout des sprites dans les cases
            for (var l = 0; l < this.nbLigne; l++) {
                for (var c = 0; c < this.nbColonne; c++) {
                    var cellule = game.add.sprite(this.startX + (tailleCellule * l), this.startY + (tailleCellule * c), 'cellule');
                    cellule.setScaleMinMax(0.90, 0.90);
                    cellule.anchor.x = -0.07;
                    cellule.anchor.y = -0.07;
                    cellule.isAlive = false;
                    cellule.visible = false;
                    cellule.nextTurn = null;
                    this.grille[l][c] = cellule;
                }
            }

            //ajout du bouton start
            this.buttonStart = game.add.button(game.world.width / 2, game.world.height - 100, 'cellule', this.nextState, this);
            this.buttonStart.scale.setTo(2, 1);
            var textButtonStart = game.add.text(0, 5, "Start", {font: "16px Arial", fill: "#000000", align: "center"});
            this.buttonStart.addChild(textButtonStart);
        },
        update: function () {

            //gestion de l'editeur
            var caseX = Math.floor((game.input.activePointer.x - this.startX) / 32);
            var caseY = Math.floor((game.input.activePointer.y - this.startY) / 32);

            if (game.input.activePointer.leftButton.isDown
                && caseY < this.nbLigne
                && caseY >= 0
                && caseX >= 0
                && caseX < this.nbColonne
                && game.time.now > this.nextClick) {

                this.nextClick = game.time.now + this.latenceClick;
                var cel = this.grille[caseX][caseY];
                if (cel.isAlive === true) {
                    cel.isAlive = false;
                    cel.visible = false;
                } else {
                    cel.isAlive = true;
                    cel.visible = true;
                }
            }
            //gestion du jeu
            if (this.start === true && this.buttonStart.visible === true) {
                game.time.desiredFps = this.fps;
                this.buttonStart.visible = false;
            }
            if (this.start === true && this.cycle === true) {
                this.cycle = false;
                var celluleModifier = [];
                var nbCelluleDead = 0;
                for (var y = 0; y < this.nbLigne; y++) {
                    for (var x = 0; x < this.nbColonne; x++) {
                        var cellule = this.grille[x][y];
                        var compteur = 0;
                        this.isAlive(x - 1, y - 1) ? compteur++ : null;
                        this.isAlive(x, y - 1) ? compteur++ : null;
                        this.isAlive(x + 1, y - 1) ? compteur++ : null;
                        this.isAlive(x - 1, y) ? compteur++ : null;
                        this.isAlive(x + 1, y) ? compteur++ : null;
                        this.isAlive(x - 1, y + 1) ? compteur++ : null;
                        this.isAlive(x, y + 1) ? compteur++ : null;
                        this.isAlive(x + 1, y + 1) ? compteur++ : null;
                        if (compteur === 3) {
                            cellule.nextTurn = 'life';
                            celluleModifier.push(cellule);
                        }
                        else if (compteur < 2 || compteur > 3) {
                            cellule.nextTurn = 'dead';
                            celluleModifier.push(cellule);
                            nbCelluleDead++;
                        }
                        else {
                            cellule.nextTurn = null;
                        }
                    }
                }
                for (var m = 0; m < celluleModifier.length; m++) {
                    var tmp = celluleModifier[m];
                    if (tmp.nextTurn === 'life') {
                        tmp.isAlive = true;
                        tmp.visible = true;
                        tmp.nextTurn = null;
                    }
                    else if (tmp.nextTurn === 'dead') {
                        tmp.isAlive = false;
                        tmp.visible = false;
                        tmp.nextTurn = null;
                    }
                    else {
                        tmp.nextTurn = null;
                    }
                }
                if (nbCelluleDead === this.tailleGrille) {
                    alert('Toutes les cellules sont mortes :(');
                    game.time.desiredFps = 30;
                    game.state.start('editor');
                }
                this.cycle = true;
            }

        }
        , render: function () {
            for (var i = 0; i < this.tabLine.length; i++) {
                game.debug.geom(this.tabLine[i], 'LightSeaGreen');
            }
        }
        , nextState: function () {
            this.start = true;
        }
        , isAlive: function (px, py) {
            try {
                var enVie = this.grille[px][py].isAlive;
            }
            catch (e) {
                return false;
            }
            return enVie;
        }
    };
    //ajout des games states
    game.state.add('intro', intro);
    game.state.add('editor', editor);
    //choix de la première scene
    game.state.start('intro');
</script>
</body>

</html>