<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Life Game - Gamecodeur GameJam #3</title>
    <script type="text/javascript" src="./js/phaser.min.js"></script>
    <style type="text/css">
    body {
        margin: 0;
        text-align: center;
        background-color: linen;
    }

    #game {
        width: 800px;
        height: 600px;
        margin-left: auto;
        margin-right: auto;
        margin-top: 50px;
    }
    </style>
</head>

<body>
    <div id='game'></div>
    <script type="text/javascript">

        //crée la fenetre de jeu
        var game = new Phaser.Game(800, 600, Phaser.CANVAS, 'game');

        //variable "globale"
        var Play = {

            //importe dans le jeu les assets (appeller qu'une seule fois)
            preload: function () {
                game.load.image('cellule', './img/cellule.jpg');


                var fps = 30;
                var tailleGrille = 7;
                var nbCellule = tailleGrille * tailleGrille;
                var start = false;
                var cycle = true;
                //        var depart = [
                //                    [1, 1, 0, 0]
                //                    , [1, 0, 0, 0]
                //                    , [0, 0, 0, 1]
                //                    , [0, 0, 1, 1]
                //                ]
                //        var depart = [
                  //          [0, 1, 0]
                    //        , [0, 1, 0]
                      //      , [0, 1, 0]
                        //]
                //        var depart = [
                //            [0,0,0,0,1,1,0,0,0,0],
                //            [0,0,0,1,0,0,1,0,0,0],
                //            [0,0,0,1,0,1,0,0,0,0],
                //            [0,1,1,0,1,0,0,0,1,0],
                //            [1,0,0,1,0,0,0,1,0,1],
                //            [1,0,1,0,0,0,1,0,0,1],
                //            [0,1,0,0,0,1,0,1,1,0],
                //            [0,0,0,0,1,0,1,0,0,0],
                //            [0,0,0,1,0,0,1,0,0,0],
                //            [0,0,0,0,1,1,0,0,0,0],
                //        ]
                var depart = [
                [0,0,1,0,0,0,0],
                [1,1,0,0,0,0,0],
                [0,0,1,1,0,0,0],
                [0,1,0,0,0,1,0],
                [0,0,0,1,1,0,0],
                [0,0,0,0,0,1,1],
                [0,0,0,0,1,0,0],
                ]
                //var depart = [
                  //    [0, 0, 1, 0, 0, 0, 0]
                  //  , [0, 1, 0, 1, 0, 0, 0]
                  //  , [1, 0, 0, 1, 0, 0, 0]
                  //  , [0, 1, 1, 0, 1, 1, 0]
                  //  , [0, 0, 0, 1, 0, 0, 1]
                  //  , [0, 0, 0, 1, 0, 1, 0]
                  //  , [0, 0, 0, 0, 1, 0, 0]
                //, ]
                //var depart = [
                  //  [1,1,0,0,0],
                  //  [1,0,1,0,0],
                  //  [0,0,0,0,0],
                  //  [0,0,1,0,1],
                  //  [0,0,0,1,1],
                //]
                //var depart = [
                //    [1,1,1],
                //    [0,0,1],
                //    [0,1,0]
                //]
                
                var grille;



            },
            //create qui initialise le jeu (appeller qu'une seule fois)
            create:function () {



                //fixe les fps du jeu
                game.time.desiredFps = this.fps;
                //active la physique type arcade
                game.physics.startSystem(Phaser.Physics.ARCADE);
                //grille de jeu
                this.grille = new Array(this.tailleGrille);
                for (var g = 0; g < this.tailleGrille; g++) {
                    this.grille[g] = new Array(this.tailleGrille);
                }
                //définition de la position de l'aire de jeu (grille)
                var tailleCellule = game.cache.getImage('cellule').width;
                var tailleAireDeJeu = tailleCellule * this.tailleGrille;
                var pointDepartGrilleX = (game.world.width - tailleAireDeJeu) / 2;
                var pointDepartGrilleY = (game.world.height - tailleAireDeJeu) / 2;
                for (var i = 0; i < this.tailleGrille; i++) {
                    for (var j = 0; j < this.tailleGrille; j++) {
                        var cellule = game.add.sprite(pointDepartGrilleX + (tailleCellule * j), pointDepartGrilleY + (tailleCellule * i), 'cellule');
                        cellule.setScaleMinMax(0.95, 0.95);
                        cellule.isAlive = false;
                        cellule.visible = false;
                        cellule.nextTurn = null;
                        if (this.depart[i][j] === 1) {
                            cellule.isAlive = true;
                            cellule.visible = true;
                        }
                        this.grille[i][j] = cellule;
                    }
                }
                game.input.mouse.capture = true;
            },
            //boucle qui met a jour l'ecran de jeu x fois par seconde 
            update: function () {
                if(game.input.keyboard.isDown(Phaser.Keyboard.SPACEBAR) 
                    || game.input.activePointer.leftButton.isDown
                    ){
                    this.start = true;
            }
            if(this.start === true && this.cycle === true){
                this.cycle = false;
                var celluleModifier = new Array();
                var nbCelluleDead = 0;
                for (var y = 0; y < this.tailleGrille; y++) {
                    for (var x = 0; x < this.tailleGrille; x++) {
                        var cellule = this.grille[x][y];
                        var compteur = 0;
                        this.isAlive(x - 1, y - 1) ? compteur++ : null;
                        this.isAlive(x, y - 1) ? compteur++ : null;
                        this.isAlive(x + 1, y - 1) ? compteur++ : null;
                        this.isAlive(x - 1, y) ? compteur++ : null;
                        this.isAlive(x + 1, y) ? compteur++ : null;
                        this.isAlive(x - 1, y + 1) ? compteur++ : null;
                        this.isAlive(x, y + 1) ? compteur++ : null;
                        this.isAlive(x + 1, y + 1) ? compteur++ : null;
                        if (compteur === 3) {
                            cellule.nextTurn = 'life';
                            celluleModifier.push(cellule);
                        }
                        else if (compteur < 2 || compteur > 3) {
                            cellule.nextTurn = 'dead';
                            celluleModifier.push(cellule);
                            nbCelluleDead++;
                        }
                        else {
                            cellule.nextTurn = null;
                        }
                    }
                }
                for (var m = 0; m < celluleModifier.length; m++) {
                    var tmp = celluleModifier[m];
                    if (tmp.nextTurn === 'life') {
                        tmp.isAlive = true;
                        tmp.visible = true;
                        tmp.nextTurn = null;
                    }
                    else if (tmp.nextTurn === 'dead') {
                        tmp.isAlive = false;
                        tmp.visible = false;
                        tmp.nextTurn = null;
                    }
                    else {
                        tmp.nextTurn = null;
                    }
                }
                if (nbCelluleDead === this.nbCellule) {
                    alert('fini');
                    game.destroy();
                }
                console.log('loop');
                this.cycle = true;    
            }

        },
            //test si la cellule est vivante
            isAlive: function (px, py) {
                try {
                    var tmp = this.grille[px][py].isAlive;
                }
                catch (e) {
                    return false;
                }
                return tmp;
            }
        };

        //add gamestate
        game.state.add('Play', Play);

        //premiere scene
        game.state.start('Play');
        
        </script>
    </body>

    </html>