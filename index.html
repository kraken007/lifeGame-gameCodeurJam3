<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Life Game - Gamecodeur GameJam #3</title>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/phaser/2.6.2/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
            text-align: center;
            background-color: linen;
        }
        
        #game {
            width: 800px;
            height: 600px;
            margin-left: auto;
            margin-right: auto;
            margin-top: 50px;
        }
    </style>
</head>

<body>
    <div id='game'></div>
    <script type="text/javascript">
        //crée la fenetre de jeu
        var game = new Phaser.Game(800, 600, Phaser.CANVAS, 'game', {
            preload: preload
            , create: create
            , update: update
        });
        //variable "globale"
        var fps = 3;
        var tailleGrille = 7;
        var nbCellule = tailleGrille * tailleGrille;
        //        var depart = [
        //                    [1, 1, 0, 0]
        //                    , [1, 0, 0, 0]
        //                    , [0, 0, 0, 1]
        //                    , [0, 0, 1, 1]
        //                ]
        //        var depart = [
        //            [0, 1, 0]
        //            , [0, 1, 0]
        //            , [0, 1, 0]
        //        ]
        //        var depart = [
        //            [0,0,0,0,1,1,0,0,0,0],
        //            [0,0,0,1,0,0,1,0,0,0],
        //            [0,0,0,1,0,1,0,0,0,0],
        //            [0,1,1,0,1,0,0,0,1,0],
        //            [1,0,0,1,0,0,0,1,0,1],
        //            [1,0,1,0,0,0,1,0,0,1],
        //            [0,1,0,0,0,1,0,1,1,0],
        //            [0,0,0,0,1,0,1,0,0,0],
        //            [0,0,0,1,0,0,1,0,0,0],
        //            [0,0,0,0,1,1,0,0,0,0],
        //        ]
        //        var depart = [
        //            [0,0,1,0,0,0,0],
        //            [1,1,0,0,0,0,0],
        //            [0,0,1,1,0,0,0],
        //            [0,1,0,0,0,1,0],
        //            [0,0,0,1,1,0,0],
        //            [0,0,0,0,0,1,1],
        //            [0,0,0,0,1,0,0],
        //        ]
        var depart = [
            [0, 0, 1, 0, 0, 0, 0]
            , [0, 1, 0, 1, 0, 0, 0]
            , [1, 0, 0, 1, 0, 0, 0]
            , [0, 1, 1, 0, 1, 1, 0]
            , [0, 0, 0, 1, 0, 0, 1]
            , [0, 0, 0, 0, 1, 0, 1]
            , [0, 0, 0, 0, 0, 1, 0]
        , ]
        var grille;
        //importe dans le jeu les assets (appeller qu'une seule fois)
        function preload() {
            game.load.image('cellule', './img/cellule.jpg');
        }
        //create qui initialise le jeu (appeller qu'une seule fois)
        function create() {
            //fixe les fps du jeu
            game.time.desiredFps = fps;
            //active la physique type arcade
            game.physics.startSystem(Phaser.Physics.ARCADE);
            //grille de jeu
            grille = new Array(tailleGrille);
            for (var g = 0; g < tailleGrille; g++) {
                grille[g] = new Array(tailleGrille);
            }
            //définition de la position de l'aire de jeu (grille)
            var tailleCellule = game.cache.getImage('cellule').width;
            var tailleAireDeJeu = tailleCellule * tailleGrille;
            var pointDepartGrilleX = (game.world.width - tailleAireDeJeu) / 2;
            var pointDepartGrilleY = (game.world.height - tailleAireDeJeu) / 2;
            for (var i = 0; i < tailleGrille; i++) {
                for (var j = 0; j < tailleGrille; j++) {
                    var cellule = game.add.sprite(pointDepartGrilleX + (tailleCellule * j), pointDepartGrilleY + (tailleCellule * i), 'cellule');
                    cellule.setScaleMinMax(0.95, 0.95);
                    cellule.isAlive = false;
                    cellule.visible = false;
                    cellule.nextTurn = null;
                    if (depart[i][j] === 1) {
                        cellule.isAlive = true;
                        cellule.visible = true;
                    }
                    grille[i][j] = cellule;
                }
            }
        }
        //boucle qui met a jour l'ecran de jeu x fois par seconde 
        function update() {
            var celluleModifier = new Array();
            var nbCelluleDead = 0;
            for (var y = 0; y < tailleGrille; y++) {
                for (var x = 0; x < tailleGrille; x++) {
                    var cellule = grille[x][y];
                    var compteur = 0;
                    isAlive(x - 1, y - 1) ? compteur++ : null;
                    isAlive(x, y - 1) ? compteur++ : null;
                    isAlive(x + 1, y - 1) ? compteur++ : null;
                    isAlive(x - 1, y) ? compteur++ : null;
                    isAlive(x + 1, y) ? compteur++ : null;
                    isAlive(x - 1, y + 1) ? compteur++ : null;
                    isAlive(x, y + 1) ? compteur++ : null;
                    isAlive(x + 1, y + 1) ? compteur++ : null;
                    if (compteur === 3) {
                        cellule.nextTurn = 'life';
                        celluleModifier.push(cellule);
                    }
                    else if (compteur < 2 || compteur > 3) {
                        cellule.nextTurn = 'dead';
                        celluleModifier.push(cellule);
                        nbCelluleDead++;
                    }
                    else {
                        cellule.nextTurn = null;
                    }
                }
            }
            for (var m = 0; m < celluleModifier.length; m++) {
                var tmp = celluleModifier[m];
                if (tmp.nextTurn === 'life') {
                    tmp.isAlive = true;
                    tmp.visible = true;
                    tmp.nextTurn = null;
                }
                else if (tmp.nextTurn === 'dead') {
                    tmp.isAlive = false;
                    tmp.visible = false;
                    tmp.nextTurn = null;
                }
                else {
                    tmp.nextTurn = null;
                }
            }
            if (nbCelluleDead === nbCellule) {
                alert('fini');
                game.destroy();
            }
            console.log('loop');
        }
        //test si la cellule est vivante
        function isAlive(px, py) {
            try {
                var tmp = grille[px][py].isAlive;
            }
            catch (e) {
                return false;
            }
            return tmp;
        }
    </script>
</body>

</html>